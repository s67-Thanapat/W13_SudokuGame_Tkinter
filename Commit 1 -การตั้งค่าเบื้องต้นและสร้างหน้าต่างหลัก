import tkinter as tk
from tkinter import messagebox
import random
import copy

class SudokuGame:
    BOARD_SIZE = 9
    SUBGRID_SIZE = 3
    CELL_SIZE = 50
    MAX_WRONG_ATTEMPTS = 3

    def __init__(self, master):
        self.master = master
        self.master.title("ซูโดกุ")
        self.game_frame = tk.Frame(self.master)
        self.game_frame.pack(pady=20)

        self.create_grid()
        self.create_input_fields()

        # สร้างกรอบสำหรับปุ่ม
        self.button_frame = tk.Frame(self.master)
        self.button_frame.pack(pady=10)
        
        self.create_buttons()
        self.reset_board()

    def create_grid(self):
        self.canvas = tk.Canvas(self.game_frame, width=self.CELL_SIZE * self.BOARD_SIZE, 
                                height=self.CELL_SIZE * self.BOARD_SIZE)
        self.canvas.grid(row=0, column=0, columnspan=self.BOARD_SIZE)

        for i in range(self.BOARD_SIZE + 1):
            line_width = 3 if i % self.SUBGRID_SIZE == 0 else 1
            self.canvas.create_line(0, i * self.CELL_SIZE, 
                                    self.CELL_SIZE * self.BOARD_SIZE, i * self.CELL_SIZE, 
                                    width=line_width)
            self.canvas.create_line(i * self.CELL_SIZE, 0, 
                                    i * self.CELL_SIZE, self.CELL_SIZE * self.BOARD_SIZE, 
                                    width=line_width)

    def create_input_fields(self):
        self.cells = []
        for i in range(self.BOARD_SIZE):
            row = []
            for j in range(self.BOARD_SIZE):
                var = tk.StringVar()
                vcmd = (self.master.register(self.validate_input), '%P')
                entry = tk.Entry(self.game_frame, width=2, justify='center', font=('Arial', 18),
                                 textvariable=var, validate='key', validatecommand=vcmd)
                entry.place(x=j * self.CELL_SIZE + 5, y=i * self.CELL_SIZE + 5,
                           width=self.CELL_SIZE - 10, height=self.CELL_SIZE - 10)
                var.trace_add('write', lambda name, index, mode, var=var, i=i, j=j: self.validate_cell(var, i, j))
                row.append(entry)
            self.cells.append(row)

    def create_buttons(self):
        # ปุ่ม Reset Game
        self.reset_button = tk.Button(self.button_frame, text="Reset Game", command=self.reset_board)
        self.reset_button.pack(side=tk.LEFT, padx=20)

        # ปุ่ม Save Game
        self.save_button = tk.Button(self.button_frame, text="Save Game", command=self.save_game)
        self.save_button.pack(side=tk.LEFT, padx=20)

        # ปุ่ม Load Game
        self.load_button = tk.Button(self.button_frame, text="Load Game", command=self.load_game)
        self.load_button.pack(side=tk.LEFT, padx=20)

    def validate_input(self, P):
        return P == "" or (P.isdigit() and 1 <= int(P) <= 9)

    def reset_board(self):
        self.wrong_attempts = 0
        board = [[0 for _ in range(self.BOARD_SIZE)] for _ in range(self.BOARD_SIZE)]
        self.fill_board(board)
        self.solution = copy.deepcopy(board)
        self.remove_numbers_from_board(board)
        self.starting_puzzle = copy.deepcopy(board)
        self.update_cells(board)

    def fill_board(self, board):
        def is_valid(board, row, col, num):
            for i in range(self.BOARD_SIZE):
                if board[row][i] == num or board[i][col] == num:
                    return False
            start_row, start_col = self.SUBGRID_SIZE * (row // self.SUBGRID_SIZE), self.SUBGRID_SIZE * (col // self.SUBGRID_SIZE)
            for i in range(self.SUBGRID_SIZE):
                for j in range(self.SUBGRID_SIZE):
                    if board[start_row + i][start_col + j] == num:
                        return False
            return True

        def solve(board):
            for row in range(self.BOARD_SIZE):
                for col in range(self.BOARD_SIZE):
                    if board[row][col] == 0:
                        nums = list(range(1, self.BOARD_SIZE + 1))
                        random.shuffle(nums)
                        for num in nums:
                            if is_valid(board, row, col, num):
                                board[row][col] = num
                                if solve(board):
                                    return True
                                board[row][col] = 0
                        return False
            return True

        solve(board)

    def remove_numbers_from_board(self, board):
        num_to_remove = 30  # จำนวนเซลล์ที่ต้องลบ
        removed = 0
        while removed < num_to_remove:
            row = random.randint(0, self.BOARD_SIZE - 1)
            col = random.randint(0, self.BOARD_SIZE - 1)
            if board[row][col] != 0:
                board[row][col] = 0
                removed += 1

    def update_cells(self, board):
        for i in range(self.BOARD_SIZE):
            for j in range(self.BOARD_SIZE):
                self.cells[i][j].config(state='normal', bg='white')
                self.cells[i][j].delete(0, tk.END)
                if board[i][j] != 0:
                    self.cells[i][j].insert(0, str(board[i][j]))
                    self.cells[i][j].config(state='disabled', disabledforeground='black')

    def save_game(self):
        messagebox.showinfo("Save Game", "เกมถูกบันทึกเรียบร้อยแล้ว!")
        
    def load_game(self):
        messagebox.showinfo("Load Game", "โหลดเกมสำเร็จ!")

if __name__ == "__main__":
    root = tk.Tk()
    game = SudokuGame(root)
    root.mainloop()
